#!/bin/bash
COLOR="$(tput setaf 11)"
BOLD="$(tput bold)"
RESET="$(tput sgr0)"

if test "$#" -gt 0; then
    PHP_COMMAND="$1"; shift
else
    PHP_COMMAND=php
fi

if test "$#" -gt 0; then
    echo "USAGE: $(basename "$0") [PHP_COMMAND]"
    echo "Run tests with varying dependencies."
    echo "Parameters:"
    echo " - PHP_COMMAND (optional) path to PHP executable, e.g. '/usr/bin/php'"
    exit 1
fi

echo "${COLOR}Using the PHP command ${BOLD}${PHP_COMMAND}${RESET}"

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
echo "${COLOR}Running diversitest from directory ${BOLD}${SCRIPT_DIR}${RESET}"

BUILD_DIR="$(mktemp -d)"
echo "${COLOR}Created a temporary directory ${BOLD}${BUILD_DIR}${RESET}"

echo "${COLOR}Setting permissions for the temporary directory${RESET}"
chmod a+rsx "${BUILD_DIR}"

echo "${COLOR}Copying from local directory${RESET}"
cp -R . "${BUILD_DIR}"

echo "${COLOR}Changing dir to ${BOLD}${BUILD_DIR}${RESET}"
cd "${BUILD_DIR}"

echo "${COLOR}Running tests${RESET}"
"${PHP_COMMAND}" "${SCRIPT_DIR}/diversitest.php"

echo "${COLOR}Cleaning up temporary dir ${BOLD}${BUILD_DIR}${RESET}"
rm -rf "${BUILD_DIR}"

echo "${COLOR}Done${RESET}"
exit 0
